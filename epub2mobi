#!/usr/bin/env python3

import os
import subprocess
from functools import reduce

def epub2mobi(fromdir, todir, ignore_if=None):
    """Look for .epub files in fromdir, convert them to .mobi and store 
    them in the flat directory todir unless their path includes any string
    present in the list ignore_if. 

    Requires ebook-convert, coming from calibre (https://calibre-ebook.com). 
    Go to Preferences, select Miscellaneous in Advanced, and click the 
    "Install command line tools" button.
    """
    if not os.path.exists(todir):
        os.makedirs(todir)
    
    for root, dirs, files in os.walk(fromdir):
        # Check if the current directory should be ignored
        if ignore_if is not None:
            if any(ig in root for ig in ignore_if):
                continue
        
        for file in files:
            name, ext = os.path.splitext(file)
            if ext.lower() == '.epub':
                mobi_path = os.path.join(todir, f"{name}.mobi")
                if not os.path.exists(mobi_path):
                    epub_path = os.path.join(root, file)
                    try:
                        subprocess.run(['ebook-convert', epub_path, mobi_path], check=True)
                        print(f"Converted {epub_path} to {mobi_path}")
                    except subprocess.CalledProcessError as e:
                        print(f"Failed to convert {epub_path}: {e}")

if __name__ == '__main__':
    import sys

    fromdir = '.'
    todir = 'kindle'

    if len(sys.argv) > 1:
        fromdir = sys.argv[1]
    if len(sys.argv) > 2:
        todir = sys.argv[2]

    epub2mobi(fromdir, todir, ignore_if=['ninios'])
